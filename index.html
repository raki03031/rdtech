<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduShare - File Sharing Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Arial, sans-serif; background:#0f1226; color:#fff; margin:0; }
    header { background:#1c1f38; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; }
    .logo { display:flex; align-items:center; gap:8px; font-size:20px; }
    main { padding:20px; }
    .upload-btn { padding:8px 16px; background:#ffd43b; color:#000; border:none; border-radius:6px; cursor:pointer; }
    .files-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:16px; margin-top:20px; }
    .file-card { background:#1c1f38; padding:12px; border-radius:8px; }
    .file-actions { display:flex; gap:8px; margin-top:8px; }
    .action-btn { flex:1; padding:6px; border:none; border-radius:6px; cursor:pointer; font-size:12px; }
    .download-btn { background:#4a6fa5; color:#fff; }
    .preview-btn { background:#ffd43b; color:#000; }
    #previewPage { display:none; padding:20px; }
    #previewArea { background:#1c1f38; padding:20px; border-radius:8px; min-height:300px; margin-top:12px; }
    img { max-width:100%; border-radius:6px; }
    iframe { width:100%; height:500px; border:none; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <div class="logo"><i class="fas fa-file-import"></i> <span>EDUSHARE</span></div>
    <button id="showUploadBtn" class="upload-btn"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
  </header>

  <main>
    <!-- Dashboard -->
    <div id="dashboardPage">
      <h2>Shared Files</h2>
      <div class="files-grid" id="filesGrid"><p>No files uploaded yet.</p></div>
    </div>

    <!-- Preview Page -->
    <div id="previewPage">
      <button id="backBtn" class="upload-btn"><i class="fas fa-arrow-left"></i> Back</button>
      <h2 id="previewFileName"></h2>
      <div id="previewArea"></div>
      <div class="file-actions">
        <button id="downloadPreviewBtn" class="download-btn action-btn">Download</button>
      </div>
    </div>
  </main>

  <!-- Hidden file input -->
  <input type="file" id="fileInput" multiple style="display:none">

  <!-- Firebase Setup -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    // ✅ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBc6Vv0c77J3pktRuqgDQdXtfrwXkW06Lg",
      authDomain: "edushear-92b44.firebaseapp.com",
      projectId: "edushear-92b44",
      storageBucket: "edushear-92b44.appspot.com", // ✅ fixed
      messagingSenderId: "493000206733",
      appId: "1:493000206733:web:b5067827f0706b292cb5c4",
      measurementId: "G-D1WLLZT7LQ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const storage = getStorage(app);

    // DOM elements
    const fileInput = document.getElementById("fileInput");
    const showUploadBtn = document.getElementById("showUploadBtn");
    const filesGrid = document.getElementById("filesGrid");
    const previewPage = document.getElementById("previewPage");
    const dashboardPage = document.getElementById("dashboardPage");
    const previewArea = document.getElementById("previewArea");
    const previewFileName = document.getElementById("previewFileName");
    const backBtn = document.getElementById("backBtn");
    const downloadPreviewBtn = document.getElementById("downloadPreviewBtn");

    let uploadedFiles = [];
    let selectedFile = null;

    // Utils
    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024, sizes = ["Bytes","KB","MB","GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k,i)).toFixed(2)) + " " + sizes[i];
    }
    function getFileType(name){
      const ext = name.split(".").pop().toLowerCase();
      if(["jpg","jpeg","png","gif","bmp"].includes(ext)) return "image";
      if(ext==="pdf") return "pdf";
      if(ext==="txt") return "txt";
      return "other";
    }

    // Upload handler
    showUploadBtn.addEventListener("click", ()=> fileInput.click());
    fileInput.addEventListener("change", async (e)=>{
      for (const file of e.target.files) {
        const id = Date.now() + "_" + file.name;
        const storageRef = ref(storage, "uploads/" + id);

        try {
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          console.log("✅ Uploaded:", file.name, "URL:", url);

          const fileObj = {
            id,
            name: file.name,
            size: formatFileSize(file.size),
            type: getFileType(file.name),
            url
          };

          uploadedFiles.push(fileObj);
          renderFiles();
        } catch (err) {
          console.error("❌ Upload failed:", err);
          alert("Upload failed. Check Firebase rules/config.");
        }
      }
    });

    // Render dashboard
    function renderFiles(){
      filesGrid.innerHTML="";
      if(uploadedFiles.length === 0){
        filesGrid.innerHTML = "<p>No files uploaded yet.</p>";
        return;
      }
      uploadedFiles.forEach(file=>{
        const card=document.createElement("div");
        card.className="file-card";
        card.innerHTML=`
          <div class="file-name">${file.name}</div>
          <div class="file-details">${file.size}</div>
          <div class="file-actions">
            <button class="action-btn download-btn">Download</button>
            <button class="action-btn preview-btn">Preview</button>
          </div>`;
        card.querySelector(".download-btn").addEventListener("click",()=> downloadFile(file));
        card.querySelector(".preview-btn").addEventListener("click",()=> showPreview(file));
        filesGrid.appendChild(card);
      });
    }

    // Download
    function downloadFile(file){
      const a=document.createElement("a");
      a.href=file.url; a.download=file.name;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
    }

    // Preview
    function showPreview(file){
      selectedFile=file;
      previewFileName.textContent=file.name;
      previewArea.innerHTML="";

      switch(file.type){
        case "image":
          previewArea.innerHTML=`<img src="${file.url}" alt="${file.name}">`;
          break;
        case "pdf":
          previewArea.innerHTML=`<iframe src="${file.url}"></iframe>`;
          break;
        case "txt":
          fetch(file.url).then(res=>res.text()).then(text=>{
            previewArea.innerHTML=`<pre style="white-space:pre-wrap">${text}</pre>`;
          });
          break;
        default:
          previewArea.innerHTML=`<p>No preview. <a href="${file.url}" target="_blank">Open File</a></p>`;
      }
      dashboardPage.style.display="none";
      previewPage.style.display="block";
    }

    // Back button
    backBtn.addEventListener("click", ()=>{
      previewPage.style.display="none";
      dashboardPage.style.display="block";
    });

    // Download from preview
    downloadPreviewBtn.addEventListener("click", ()=>{
      if(selectedFile) downloadFile(selectedFile);
    });
  </script>
</body>
</html>
